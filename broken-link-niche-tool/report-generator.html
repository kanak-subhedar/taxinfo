<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>CSV Sales Report Generator</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- Chart.js v4 (locked) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.1"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f6f8;
  margin: 0;
}
.container {
  max-width: 1100px;
  margin: auto;
  padding: 20px;
}
.box {
  background: #fff;
  padding: 20px;
  border-radius: 8px;
  border: 1px solid #ddd;
  margin-bottom: 25px;
}
h1 { text-align: center; }
button {
  padding: 10px 16px;
  background: #2563eb;
  color: #fff;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}
button:hover { background: #1e40af; }
.error { color: red; font-weight: bold; }
.log {
  background: #0f172a;
  color: #e5e7eb;
  padding: 10px;
  font-family: monospace;
  font-size: 13px;
  height: 150px;
  overflow-y: auto;
}
canvas {
  width: 100% !important;
  height: 380px !important;
}
.explain {
  font-size: 14px;
  color: #444;
  margin-top: 6px;
}
</style>
</head>

<body>
<div class="container">

<h1>CSV Sales Report Generator</h1>

<div class="box">
<h3>Required CSV Columns</h3>
<ul>
<li>Product_Name</li>
<li>Quantity</li>
<li>Product_Price</li>
<li>City</li>
<li>Date</li>
<li>Sales_Amount</li>
<li>Purchase_Amount</li>
<li>Seller_Name</li>
<li>Gain</li>
</ul>

<input type="file" id="csvFile" accept=".csv" />
<br><br>
<button onclick="start()">Generate Report</button>
<p id="error" class="error"></p>
</div>

<div class="box">
<h3>Execution Log</h3>
<div id="log" class="log"></div>
</div>

<div class="box">
<canvas id="barChart"></canvas>
<p class="explain">Sales amount per product.</p>
</div>

<div class="box">
<canvas id="pieChart"></canvas>
<p class="explain">City-wise total sales distribution.</p>
</div>

<div class="box">
<canvas id="lineChart"></canvas>
<p class="explain">Gain trend over time.</p>
</div>

</div>

<script>
let barChart, pieChart, lineChart;

function log(msg) {
  const el = document.getElementById("log");
  el.textContent += msg + "\n";
  el.scrollTop = el.scrollHeight;
}

function start() {
  document.getElementById("log").textContent = "";
  document.getElementById("error").textContent = "";

  const file = document.getElementById("csvFile").files[0];
  if (!file) {
    document.getElementById("error").textContent = "Please upload a CSV file.";
    return;
  }

  log("Reading CSV file...");
  const reader = new FileReader();
  reader.onload = e => parseCSV(e.target.result);
  reader.readAsText(file);
}

function parseCSV(text) {
  log("Parsing CSV...");
  const rows = text.trim().split("\n").map(r => r.split(","));
  const headers = rows[0].map(h => h.trim().toLowerCase());

  const required = [
    "product_name","quantity","product_price","city","date",
    "sales_amount","purchase_amount","seller_name","gain"
  ];

  const idx = {};
  for (const col of required) {
    idx[col] = headers.indexOf(col);
    if (idx[col] === -1) {
      document.getElementById("error").textContent =
        "Missing required column: " + col;
      return;
    }
  }

  log("Headers detected successfully.");
  log("Processing rows...");

  const salesByProduct = {};
  const salesByCity = {};
  const gainByDate = {};

  for (let i = 1; i < rows.length; i++) {
    const r = rows[i];
    const product = r[idx.product_name];
    const city = r[idx.city];
    const date = r[idx.date];
    const sales = parseFloat(r[idx.sales_amount]);
    const gain = parseFloat(r[idx.gain]);

    if (!isNaN(sales)) {
      salesByProduct[product] = (salesByProduct[product] || 0) + sales;
      salesByCity[city] = (salesByCity[city] || 0) + sales;
    }
    if (!isNaN(gain)) {
      gainByDate[date] = (gainByDate[date] || 0) + gain;
    }
  }

  log("Data aggregation completed.");
  renderCharts(salesByProduct, salesByCity, gainByDate);
}

function renderCharts(prod, city, dateGain) {
  log("Rendering charts...");

  if (barChart) barChart.destroy();
  if (pieChart) pieChart.destroy();
  if (lineChart) lineChart.destroy();

  barChart = new Chart(document.getElementById("barChart"), {
    type: "bar",
    data: {
      labels: Object.keys(prod),
      datasets: [{
        label: "Sales Amount",
        data: Object.values(prod),
        backgroundColor: "#3b82f6"
      }]
    },
    options: {
      plugins: {
        legend: { display: true },
        title: { display: true, text: "Sales Amount by Product" }
      },
      scales: {
        y: { title: { display: true, text: "Amount" } }
      }
    }
  });

  pieChart = new Chart(document.getElementById("pieChart"), {
    type: "pie",
    data: {
      labels: Object.keys(city),
      datasets: [{
        data: Object.values(city),
        backgroundColor: ["#22c55e","#f97316","#a855f7","#ef4444","#14b8a6"]
      }]
    },
    options: {
      plugins: {
        legend: { display: true, position: "bottom" },
        title: { display: true, text: "City-wise Sales Distribution" }
      }
    }
  });

  const sortedDates = Object.keys(dateGain).sort();
  lineChart = new Chart(document.getElementById("lineChart"), {
    type: "line",
    data: {
      labels: sortedDates,
      datasets: [{
        label: "Gain",
        data: sortedDates.map(d => dateGain[d]),
        borderColor: "#16a34a",
        tension: 0.3
      }]
    },
    options: {
      plugins: {
        legend: { display: true },
        title: { display: true, text: "Gain Trend Over Time" }
      },
      scales: {
        x: { title: { display: true, text: "Date" } },
        y: { title: { display: true, text: "Gain Amount" } }
      }
    }
  });

  log("Charts rendered successfully.");
}
</script>
</body>
</html>
