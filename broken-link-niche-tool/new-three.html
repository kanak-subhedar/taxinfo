<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Advanced CSV Report Generator</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.1"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.min.js"></script>

<style>
body { font-family: Arial; background:#f3f4f6; margin:0; }
.container { max-width:1200px; margin:auto; padding:20px; }
.box { background:#fff; padding:20px; border-radius:8px; margin-bottom:25px; }
.chart-fixed { width:420px; height:420px; margin:auto; }
button { background:#2563eb; color:#fff; border:none; padding:10px 18px; cursor:pointer; }
button:hover { background:#1e40af; }
.log { background:#020617; color:#e5e7eb; padding:10px; height:160px; overflow:auto; }
</style>
</head>

<body>
<div class="container">

<h1>CSV Sales & Performance Analyzer</h1>

<div class="box">
<input type="file" id="csvFile" accept=".csv">
<br><br>
<button onclick="start()">Generate Report</button>
<p id="error" style="color:red"></p>
</div>

<div class="box"><div id="log" class="log"></div></div>

<div class="box"><canvas id="barChart"></canvas></div>

<div class="box"><div class="chart-fixed"><canvas id="pieChart"></canvas></div></div>

<div class="box"><div class="chart-fixed"><canvas id="doughnutChart"></canvas></div></div>

<div class="box"><canvas id="lineChart"></canvas></div>

<div class="box"><canvas id="sellerChart"></canvas></div>

<div class="box">
<canvas id="productCityQtyChart"></canvas>
<p>Product-wise quantity sold in each city</p>
</div>

<div class="box" style="text-align:center;">
<button onclick="downloadPDF()">ðŸ“„ Download PDF</button>
<button onclick="downloadPPT()">ðŸ“Š Download PPT</button>
</div>

</div>

<script>
Chart.register(ChartDataLabels);
let charts=[];

function log(m){const l=document.getElementById("log");l.textContent+=m+"\n";}

function start(){
  const f=document.getElementById("csvFile").files[0];
  if(!f){error.textContent="Upload CSV";return;}
  const r=new FileReader();
  r.onload=e=>parseCSV(e.target.result);
  r.readAsText(f);
}

function parseCSV(text){
  const rows=text.trim().split("\n").map(r=>r.split(","));
  const h=rows[0].map(x=>x.toLowerCase());

  const idx=k=>h.indexOf(k);

  let prodSales={}, prodQty={}, citySales={}, gainDate={}, sellerSales={}, sellerQty={}, sellerGain={};
  let prodCityQty={};

  let totalSales=0, totalPurchase=0;

  for(let i=1;i<rows.length;i++){
    const r=rows[i];
    const p=r[idx("product_name")];
    const q=+r[idx("quantity")];
    const s=+r[idx("sales_amount")];
    const pur=+r[idx("purchase_amount")];
    const c=r[idx("city")];
    const g=+r[idx("gain")];
    const sel=r[idx("seller_name")];
    const d=r[idx("date")];

    prodSales[p]=(prodSales[p]||0)+s;
    prodQty[p]=(prodQty[p]||0)+q;
    citySales[c]=(citySales[c]||0)+s;
    gainDate[d]=(gainDate[d]||0)+g;

    sellerSales[sel]=(sellerSales[sel]||0)+s;
    sellerQty[sel]=(sellerQty[sel]||0)+q;
    sellerGain[sel]=(sellerGain[sel]||0)+g;

    prodCityQty[c]??={};
    prodCityQty[c][p]=(prodCityQty[c][p]||0)+q;

    totalSales+=s; totalPurchase+=pur;
  }

  renderCharts(prodSales,prodQty,citySales,totalSales,totalPurchase,gainDate,
               sellerSales,sellerQty,sellerGain,prodCityQty);
}

function renderCharts(ps,pq,cs,ts,tp,gd,ss,sq,sg,pcq){
charts.forEach(c=>c.destroy()); charts=[];

charts.push(new Chart(barChart,{
 type:"bar",
 data:{labels:Object.keys(ps),
 datasets:[{label:"Sales",data:Object.values(ps),backgroundColor:"#3b82f6"}]}
}));

charts.push(new Chart(pieChart,{
 type:"pie",
 data:{labels:Object.keys(cs),datasets:[{data:Object.values(cs)}]},
 options:{plugins:{datalabels:{
   color:"#fff",backgroundColor:"#000",
   formatter:(v,ctx)=>{
     const t=ctx.dataset.data.reduce((a,b)=>a+b,0);
     return `${v} (${(v/t*100).toFixed(1)}%)`;
   }
 }}}
}));

charts.push(new Chart(doughnutChart,{
 type:"doughnut",
 data:{labels:["Sales","Purchase"],datasets:[{data:[ts,tp]}]},
 options:{plugins:{datalabels:{
   color:"#fff",backgroundColor:"#000",
   formatter:(v,ctx)=>{
     const t=ctx.dataset.data.reduce((a,b)=>a+b,0);
     return `${v} (${(v/t*100).toFixed(1)}%)`;
   }
 }}}
}));

charts.push(new Chart(lineChart,{
 type:"line",
 data:{labels:Object.keys(gd),datasets:[{data:Object.values(gd),borderColor:"#16a34a"}]}
}));

charts.push(new Chart(sellerChart,{
 type:"bar",
 data:{labels:Object.keys(ss),
 datasets:[{data:Object.values(ss),backgroundColor:"#7c3aed"}]},
 options:{indexAxis:"y"}
}));

// ðŸ”¥ NEW PRODUCTâ€“CITYâ€“QTY CHART
const cities=Object.keys(pcq);
const products=[...new Set(cities.flatMap(c=>Object.keys(pcq[c])))];

charts.push(new Chart(productCityQtyChart,{
 type:"bar",
 data:{
  labels:cities,
  datasets:products.map(p=>({
    label:p,
    data:cities.map(c=>pcq[c][p]||0)
  }))
 }
}));

}

async function downloadPDF(){
 const {jsPDF}=window.jspdf;
 const pdf=new jsPDF();
 const boxes=document.querySelectorAll(".box");
 let y=10;
 for(const b of boxes){
  const c=await html2canvas(b,{scale:2});
  const h=(c.height*190)/c.width;
  if(y+h>280){pdf.addPage();y=10;}
  pdf.addImage(c.toDataURL(),"PNG",10,y,190,h);
  y+=h+10;
 }
 pdf.save("Report.pdf");
}

function downloadPPT(){
 const ppt=new PptxGenJS();
 ["barChart","pieChart","doughnutChart","lineChart","sellerChart","productCityQtyChart"]
 .forEach(id=>{
  const s=ppt.addSlide();
  s.addImage({data:document.getElementById(id).toDataURL(),x:0.5,y:0.5,w:9});
 });
 ppt.writeFile("Report.pptx");
}
</script>
</body>
</html>
